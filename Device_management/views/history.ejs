<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lá»‹ch sá»­ phÃ²ng: <%= room.name %> - Quáº£n lÃ½ thiáº¿t bá»‹</title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Quáº£n lÃ½ thiáº¿t bá»‹</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="/dashboard">ğŸ“Š Báº£ng Ä‘iá»u khiá»ƒn</a>
        <a href="/rooms">ğŸ  Quáº£n lÃ½ phÃ²ng</a>
        <a href="/history" class="active">ğŸ“œ Lá»‹ch sá»­</a>
      </nav>
      <div class="sidebar-footer">
        <a href="/logout">ğŸšª ÄÄƒng xuáº¥t</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
  <h2>ğŸ“œ Lá»‹ch sá»­ phÃ²ng: <%= room.name %></h2>
  <p style="margin-bottom:20px;"><strong>Äá»‹a chá»‰ IP:</strong> <%= room.ip %></p>
      
      <table id="historyTable">
        <thead>
          <tr>
            <th>Thá»i gian</th>
            <th>Nhiá»‡t Ä‘á»™ (Â°C)</th>
            <th>Äá»™ áº©m (%)</th>
            <th>Tráº¡ng thÃ¡i Ä‘Ã¨n</th>
            <th>Tráº¡ng thÃ¡i quáº¡t</th>
          </tr>
        </thead>
        <tbody>
          <% if (history.length === 0) { %>
            <tr><td colspan="5" style="text-align:center;">ChÆ°a cÃ³ dá»¯ liá»‡u lá»‹ch sá»­</td></tr>
          <% } else { %>
            <% history.forEach(function(h) { %>
              <tr>
                <td><%= new Date(h.createdAt).toLocaleString('vi-VN') %></td>
                <td><%= h.temperature %>Â°C</td>
                <td><%= h.humidity %>%</td>
                <td><span class="status <%= h.status_led ? 'on' : 'off' %>"><%= h.status_led ? 'ğŸŸ¢ Báº­t' : 'ğŸ”´ Táº¯t' %></span></td>
                <td><span class="status <%= h.status_fan ? 'on' : 'off' %>"><%= h.status_fan ? 'ğŸŸ¢ Báº­t' : 'ğŸ”´ Táº¯t' %></span></td>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
      
      <div style="margin-top:20px;">
  <button onclick="location.href='/dashboard/room/<%= room.id %>'">â¬…ï¸ Quay láº¡i chi tiáº¿t phÃ²ng</button>
      </div>
    </main>
  </div>
  
  <script>
    const socket = io();
    const roomId = '<%= room.id %>';
    const historyBody = document.querySelector('#historyTable tbody');

    // Real-time: ThÃªm dÃ²ng má»›i vÃ o báº£ng lá»‹ch sá»­
    socket.on('data_from_esp32_update', data => {
      if (String(data.roomId) === roomId) {
        if (typeof data.is_online !== 'boolean') return; // KhÃ´ng cÃ³ tráº¡ng thÃ¡i thÃ¬ khÃ´ng thÃªm dÃ²ng má»›i

        // XÃ³a dÃ²ng "ChÆ°a cÃ³ dá»¯ liá»‡u" náº¿u cÃ³
        const noDataRow = historyBody.querySelector('tr td[colspan="5"]');
        if (noDataRow) {
          noDataRow.parentElement.remove();
        }

        // Táº¡o dÃ²ng má»›i
        const newRow = document.createElement('tr');
        newRow.style.animation = 'slideIn 0.5s';

        const now = new Date().toLocaleString('vi-VN');
        const temp = parseFloat(data.temperature).toFixed(1);
        const humidity = parseFloat(data.humidity).toFixed(1);
        let status_ledHtml = data.status_led=="ON"
          ? '<span class="status on">ğŸŸ¢ Báº­t</span>'
          : '<span class="status off">ğŸ”´ Táº¯t</span>';
        let status_fanHtml = data.status_fan=="ON"
          ? '<span class="status on">ğŸŸ¢ Báº­t</span>'
          : '<span class="status off">ğŸ”´ Táº¯t</span>';
        newRow.innerHTML = `
          <td>${now}</td>
          <td>${temp}Â°C</td>
          <td>${humidity}%</td>
          <td>${status_ledHtml}</td>
          <td>${status_fanHtml}</td>
        `;

        // ThÃªm vÃ o Ä‘áº§u báº£ng
        historyBody.insertBefore(newRow, historyBody.firstChild);

        // Giá»›i háº¡n 100 dÃ²ng
        if (historyBody.children.length > 100) {
          historyBody.removeChild(historyBody.lastChild);
        }

        console.log('ğŸ“Š History table updated with new data');
      }
    });
  </script>
  
  <style>
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
  </style>
</body>
</html>
