<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi ti·∫øt ph√≤ng - <%= room.name %></title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Qu·∫£n l√Ω thi·∫øt b·ªã</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="/dashboard">üìä B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
        <a href="/rooms">üè† Qu·∫£n l√Ω ph√≤ng</a>
        <a href="/history">üìú L·ªãch s·ª≠</a>
      </nav>
      <div class="sidebar-footer">
        <a href="/logout">üö™ ƒêƒÉng xu·∫•t</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <h2>Chi ti·∫øt ph√≤ng: <%= room.name %></h2>
      
      <!-- Ph·∫ßn c√†i ƒë·∫∑t -->
    <button class="settings-button" onclick="toggleSettings()">‚öôÔ∏è</button>
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-header">
        <h3>‚öôÔ∏è C√†i ƒë·∫∑t</h3>
        <button class="close-settings" onclick="toggleSettings()">√ó</button>
      </div>
      <div class="settings-content">

        <div class="setting-item">
          <h4>üåÄ Quy·ªÅn ƒëi·ªÅu khi·ªÉn qu·∫°t</h4>
          <p>Cho ph√©p ho·∫∑c t·ª´ ch·ªëi quy·ªÅn ƒëi·ªÅu khi·ªÉn qu·∫°t trong ph√≤ng n√†y</p>
          <div class="toggle-label">
            <span>Tr·∫°ng th√°i: <span class="status-badge <%= allowFan_control ? 'enabled' : 'disabled' %>" id="fanControlStatus">
              <%= allowFan_control ? 'ƒê√£ c·∫•p' : 'ƒê√£ kh√≥a' %>
            </span> </span>
            <label class="toggle-switch">
              <input type="checkbox" id="fanControlToggle" <%= allowFan_control ? 'checked' : '' %> onchange="allowFanControl()">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="setting-item">
          <h4>üîê M√£ h√≥a ƒë·ªô ·∫©m</h4>
          <p>B·∫≠t m√£ h√≥a ƒë·ªÉ b·∫£o v·ªá d·ªØ li·ªáu ƒë·ªô ·∫©m</p>
          <div class="toggle-label">
            <span>Tr·∫°ng th√°i: <span class="status-badge <%= humidityEncryption?.enabled ? 'enabled' : 'disabled' %>" id="encryptionStatus">
              <%= humidityEncryption?.enabled ? 'ƒê√£ b·∫≠t' : 'ƒê√£ t·∫Øt' %>
            </span></span>
            <label class="toggle-switch">
              <input type="checkbox" id="encryptionToggle" <%= humidityEncryption?.enabled ? 'checked' : '' %> onchange="toggleEncryption()">
              <span class="slider"></span>
            </label>
          </div>
          <!-- Hi·ªÉn th·ªã ph·∫ßn ch·ªçn thu·∫≠t to√°n khi ƒë√£ b·∫≠t m√£ h√≥a -->
          <div id="encryptionMethodSection" style="<%= humidityEncryption?.enabled ? '' : 'display:none;' %> margin-top: 20px;">
            <h5>Ch·ªçn thu·∫≠t to√°n m√£ h√≥a:</h5>
            <div class="encryption-methods">
              <div class="method-card <%= humidityEncryption?.method === 'AES-256' ? 'active' : '' %>" onclick="selectEncryptionMethod(this, 'AES-256')">
                <!-- Th√™m event v√†o ƒë·ªÉ tr√¨nh duy·ªát bi·∫øt ƒë∆∞·ª£c l√† v·ª´a m·ªõi nh·∫•n CLICK v√†o c√°i div n√†o, d√πng event.currentTarget s·∫Ω x√°c ƒë·ªãnh-->
                <div class="method-icon">üõ°Ô∏è</div>
                <div class="method-name">AES-256</div>
                <div class="method-desc">B·∫£o m·∫≠t cao, ph·ªï bi·∫øn</div>
              </div>
            <div class="method-card <%= humidityEncryption?.method === 'DES' ? 'active' : '' %>" onclick="selectEncryptionMethod(this, 'DES')">
              <div class="method-icon">üîí</div>
              <div class="method-name">DES</div>
              <div class="method-desc">C∆° b·∫£n, t·ªëc ƒë·ªô nhanh</div>
            </div>
            </div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
              Thu·∫≠t to√°n hi·ªán t·∫°i: <strong id="currentMethod"><%= humidityEncryption?.method || 'Ch∆∞a ch·ªçn' %></strong>
            </p>
          </div>
        </div>
      </div>
    </div>
    
      <!-- Th√¥ng tin ph√≤ng v√† ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã -->
      <div class="room-info">
        <p><strong>ƒê·ªãa ch·ªâ IP:</strong> <%= room.ip %></p>
        <p><strong>K·∫øt n·ªëi:</strong> <span id="is_online" class="status <%= room.is_online ? 'on' : 'off' %>"><%= room.is_online ? 'üü¢ Tr·ª±c tuy·∫øn' : '‚ö´ Ngo·∫°i tuy·∫øn' %></span></p>
        <p><strong>Tr·∫°ng th√°i ƒë√®n</strong> <span id="status_led" class="status <%= room.status_led ? 'on' : 'off' %>"><%= room.status_led ? 'üí° ƒêang b·∫≠t' : '‚ö´ ƒêang t·∫Øt' %></span></p>
        <div id="control_ledSection">
        <% if (room.is_online) { %>
          <form action="/rooms/toggle_led/<%= room.id %>" method="POST" style="margin-top:12px;">
            <button type="submit" id="toggleBtn_led"><%= room.status_led ? 'üî¥ T·∫Øt ƒë√®n' : 'üü¢ B·∫≠t ƒë√®n' %></button>
          </form>
        <% } else { %>
          <p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è ƒê√®n ƒëang ngo·∫°i tuy·∫øn. Kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn.</p>
        <% } %>
        </div>
  <p><strong> Tr·∫°ng th√°i qu·∫°t</strong> <span id="status_fan" class="status <%= room.status_fan ? 'on' : 'off' %>"><%= room.status_fan ? 'üåÄ ƒêang b·∫≠t' : '‚ö´ ƒêang t·∫Øt' %></span></p>
        <div id="control_fanSection">
        <% if (room.is_online && allowFan_control) { %>
          <form action="/rooms/toggle_fan/<%= room.id %>" method="POST" style="margin-top:12px;">
            <button type="submit" id="toggleBtn_fan"><%= room.status_fan ? 'üî¥ T·∫Øt qu·∫°t' : 'üü¢ B·∫≠t qu·∫°t' %></button>
          </form>
        <% } if (!room.is_online) { %>
          <p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è Qu·∫°t ƒëang ngo·∫°i tuy·∫øn. Kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn.</p>
        <% } if (!allowFan_control) { %>
          <p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è B·∫°n kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn qu·∫°t. H√£y v√†o c√†i ƒë·∫∑t ƒë·ªÉ c·∫•p quy·ªÅn.</p>
        <% } %>
        </div>
      </div>

      <!-- Kh·ªëi hi·ªÉn th·ªã th√¥ng tin m√£ h√≥a ƒë·ªô ·∫©m -->
      <div class="encryption-info-container" id="encryptionInfoContainer">
        <div class="encryption-header">
          <span class="encryption-icon">üîê</span>
          <h3 id="encryptionTitle">Tr·∫°ng th√°i m√£ h√≥a ƒë·ªô ·∫©m</h3>
          <span class="encryption-badge" id="encryptionBadge">
            <%= humidityEncryption?.enabled ? '‚úì ƒê√£ b·∫≠t' : '‚úó ƒê√£ t·∫Øt' %>
          </span>
        </div>
        <div class="encryption-content" id="encryptionContent"  style="<%= humidityEncryption?.enabled ? '' : 'display:none;' %>">
          <div class="encryption-method-display">
            <span class="method-label">Thu·∫≠t to√°n:</span>
            <span class="method-value" id="activeMethod">
              <%= humidityEncryption?.method || 'N/A' %>
            </span>
          </div>
          <div class="humidity-data-row">
            <div class="data-box encrypted-box">
              <div class="data-label">
                <span class="lock-icon">üîí</span>
                D·ªØ li·ªáu m√£ h√≥a
              </div>
              <div class="data-value encrypted-value" id="encryptedHumidity">
                ƒêang ch·ªù d·ªØ li·ªáu...
              </div>
            </div>
            <div class="decrypt-arrow">
              <span>‚Üí</span>
            </div>
            <div class="data-box decrypted-box">
              <div class="data-label">
                <span class="unlock-icon">üîì</span>
                D·ªØ li·ªáu gi·∫£i m√£
              </div>
              <div class="data-value decrypted-value" id="decryptedHumidity">
                ƒêang ch·ªù d·ªØ li·ªáu...
              </div>
            </div>
          </div>
        </div>
      </div>


      <div class="chart-container">
  <h3>üìà Bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô</h3>
        <canvas id="tempChart" width="400" height="150"></canvas>
      </div>

      <div class="chart-container" style="margin-top: 30px;">
  <h3>üìà Bi·ªÉu ƒë·ªì ƒë·ªô ·∫©m</h3>
        <canvas id="humidityChart" width="400" height="150"></canvas>
      </div>

      <div style="margin-top:20px;">
        <button onclick="location.href='/history/<%= room.id %>'">üìú Xem l·ªãch s·ª≠ ƒë·∫ßy ƒë·ªß</button>
      </div>
    </main>
  </div>
 <script>
  const tempData = JSON.parse('<%- JSON.stringify(history.map(h => h.temperature).reverse()) %>');
  const humidityData = JSON.parse('<%- JSON.stringify(history.map(h => h.humidity).reverse()) %>');
  const labels = JSON.parse('<%- JSON.stringify(history.map(h => (new Date(h.createdAt)).toLocaleTimeString()).reverse()) %>');
  
  let allowFan_control = <%= allowFan_control ? 'true' : 'false' %>;
  let currentEncryptionEnabled = <%= humidityEncryption?.enabled ? 'true' : 'false' %>;
  let currentEncryptionMethod = '<%= humidityEncryption?.method || "" %>';

  const ctx1 = document.getElementById('tempChart').getContext('2d');
  
  const tempChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Nhi·ªát ƒë·ªô (¬∞C)',
        data: tempData,
        borderColor: 'rgb(75, 192, 192)',
        backgroundColor: 'rgba(75, 192, 192, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: 'rgb(75, 192, 192)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(75, 192, 192)',
        pointHoverBorderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: {
        duration: 750,
        easing: 'easeInOutQuart'
      },
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: {
              size: 13,
              weight: 'bold'
            }
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return ' Nhi·ªát ƒë·ªô: ' + context.parsed.y.toFixed(1) + '¬∞C';
            }
          }
        }
      },
      scales: {
        x: {
          display: true,
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            maxTicksLimit: 10,
            font: {
              size: 11
            }
          }
        },
        y: {
          beginAtZero: true,
          min: 0,
          max: 60,
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            font: {
              size: 11
            },
            callback: function(value) {
              return value + '¬∞C';
            }
          }
        }
      }
    }
  });

  const ctx2 = document.getElementById('humidityChart').getContext('2d');
  const humidityChart = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'ƒê·ªô ·∫©m (%)',
        data: humidityData,
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: 'rgb(54, 162, 235)',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverBackgroundColor: '#fff',
        pointHoverBorderColor: 'rgb(54, 162, 235)',
        pointHoverBorderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      animation: {
        duration: 750,
        easing: 'easeInOutQuart'
      },
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            usePointStyle: true,
            padding: 15,
            font: {
              size: 13,
              weight: 'bold'
            }
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13
          },
          padding: 12,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              return ' ƒê·ªô ·∫©m: ' + context.parsed.y.toFixed(1) + '%';
            }
          }
        }
      },
      scales: {
        x: {
          display: true,
          grid: {
            display: true,
            color: 'rgba(0, 0, 0, 0.05)'
          },
          ticks: {
            maxTicksLimit: 10,
            font: {
              size: 11
            }
          }
        },
        y: {
          beginAtZero: true,
          min: 0,
          max: 100
        }
      }
    }
  });

  // H√†m gi·∫£i m√£ ƒë·ªô ·∫©m tr√™n client
  function decryptHumidity(encryptedData, method) {
    try {
      const key_value = 165743;
      let decrypted;
      
      if (method === "DES") {
        const keyDES = new Uint8Array(8);
        for (let i = 0; i < 4; i++) {
          keyDES[i] = (key_value >> (24 - i * 8)) & 0xFF;
          keyDES[i + 4] = keyDES[i];
        }
        const keyWordArray = CryptoJS.lib.WordArray.create(keyDES);
        decrypted = CryptoJS.DES.decrypt(encryptedData, keyWordArray, {
          mode: CryptoJS.mode.ECB,
          padding: CryptoJS.pad.Pkcs7
        });
      } else if (method === "AES-256") {
        const keyAES = new Uint8Array(32);
        for (let i = 0; i < 32; i += 4) {
          keyAES[i] = (key_value >> 24) & 0xFF;
          keyAES[i + 1] = (key_value >> 16) & 0xFF;
          keyAES[i + 2] = (key_value >> 8) & 0xFF;
          keyAES[i + 3] = key_value & 0xFF;
        }
        const keyWordArray = CryptoJS.lib.WordArray.create(keyAES);
        decrypted = CryptoJS.AES.decrypt(encryptedData, keyWordArray, {
          mode: CryptoJS.mode.ECB,
          padding: CryptoJS.pad.Pkcs7
        });
      }
      
      return decrypted.toString(CryptoJS.enc.Utf8);
    } catch (error) {
      console.error('Decryption error:', error);
      return 'L·ªói gi·∫£i m√£';
    }
  }

  // C·∫≠p nh·∫≠t giao di·ªán m√£ h√≥a
  function updateEncryptionDisplay(data) {
    const container = document.getElementById('encryptionInfoContainer');
    const badge = document.getElementById('encryptionBadge');
    const content = document.getElementById('encryptionContent');
    const methodDisplay = document.getElementById('activeMethod');
    const encryptedDisplay = document.getElementById('encryptedHumidity');
    const decryptedDisplay = document.getElementById('decryptedHumidity');
    
    if (data.enable_encryption) {
      currentEncryptionEnabled = true;
      container.classList.remove('disabled');
      badge.textContent = '‚úì ƒê√£ b·∫≠t';
      badge.style.background = 'rgba(46, 204, 113, 0.3)';
      content.style.display = 'block';
      methodDisplay.textContent = data.encryption_method;
      encryptedDisplay.textContent = data.humidity;
      encryptedDisplay.classList.add('updating');
      setTimeout(() => encryptedDisplay.classList.remove('updating'), 600);

      const decrypted = decryptHumidity(data.humidity);
      decryptedDisplay.textContent = decrypted + '%';
      decryptedDisplay.classList.add('updating');
      setTimeout(() => decryptedDisplay.classList.remove('updating'), 600);
    } else {
      currentEncryptionEnabled = false;
      container.classList.add('disabled');
      badge.textContent = '‚úó ƒê√£ t·∫Øt';
      badge.style.background = 'rgba(231, 76, 60, 0.3)';
      content.style.display = 'none';
    }
  }

  // H√†m hi·ªÉn th·ªã/·∫©n menu c√†i ƒë·∫∑t
  function toggleSettings() {
    const panel = document.getElementById('settingsPanel');
    const overlay = document.getElementById('settingsOverlay');
    panel.classList.toggle('active');
    overlay.classList.toggle('active');
  }

  // H√†m c·∫•p/h·ªßy quy·ªÅn ƒëi·ªÅu khi·ªÉn qu·∫°t
  function allowFanControl() {
    const checkbox = document.getElementById('fanControlToggle');
    const statusBadge = document.getElementById('fanControlStatus');
    const roomId = '<%= room.id %>';
    
    fetch(`/rooms/toggle_fan_permission/${roomId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ allowFan_control: checkbox.checked }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        statusBadge.className = 'status-badge ' + (checkbox.checked ? 'enabled' : 'disabled');
        statusBadge.textContent = checkbox.checked ? 'ƒê√£ c·∫•p' : 'ƒê√£ kh√≥a';
        setTimeout(() => location.reload(), 500);
      } else {
        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
        checkbox.checked = !checkbox.checked;
      }
    }).catch(error => {
      console.error('Error:', error);
      alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
      checkbox.checked = !checkbox.checked;
    });
  }

  // H√†m b·∫≠t/t·∫Øt m√£ h√≥a
  function toggleEncryption() {
    const checkbox = document.getElementById('encryptionToggle');
    const statusBadge = document.getElementById('encryptionStatus');
    const methodSection = document.getElementById('encryptionMethodSection');
    const roomId = '<%= room.id %>';

    fetch(`/rooms/toggle_encryption/${roomId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ 
        enabled: checkbox.checked 
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        statusBadge.className = 'status-badge ' + (checkbox.checked ? 'enabled' : 'disabled');
        statusBadge.textContent = checkbox.checked ? 'ƒê√£ b·∫≠t' : 'ƒê√£ t·∫Øt';
        methodSection.style.display = checkbox.checked ? 'block' : 'none';
        console.log('‚úÖ M√£ h√≥a ƒë·ªô ·∫©m:', checkbox.checked ? 'ƒê√£ b·∫≠t' : 'ƒê√£ t·∫Øt');

        if (checkbox.checked == false) {
          setTimeout(() => location.reload(), 500);
        }
      } else {
        alert('C√≥ l·ªói x·∫£y ra: ' + (data.message));
        checkbox.checked = !checkbox.checked;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`C√≥ l·ªói x·∫£y ra: ${error}`);
      checkbox.checked = !checkbox.checked;
    });
  }

  // H√†m ch·ªçn thu·∫≠t to√°n m√£ h√≥a
  function selectEncryptionMethod(clickElement, method) {
    const roomId = '<%= room.id %>';
    const cards = document.querySelectorAll('.method-card');
    
    fetch(`/rooms/set_encryption_method/${roomId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ 
        enabled: true,
        method: method 
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        cards.forEach(card => card.classList.remove('active'));
        clickElement.classList.add('active');
        document.getElementById('currentMethod').textContent = method;
        console.log('‚úÖ Thu·∫≠t to√°n m√£ h√≥a ƒë√£ ch·ªçn:', method);
        setTimeout(() => location.reload(), 500);
        showNotification(`ƒê√£ ch·ªçn thu·∫≠t to√°n ${method}`, 'success');
      } else {
        alert('C√≥ l·ªói x·∫£y ra: ' + (data.message));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert(`C√≥ l·ªói x·∫£y ra: ${error}`);
    });
  }

  // H√†m hi·ªÉn th·ªã th√¥ng b√°o
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: ${type === 'success' ? '#28a745' : '#007bff'};
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 10000;
      animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // ‚úÖ Socket.IO - Real-time updates
  const socket = io();
  const roomId = '<%= room.id %>';

  socket.on('connect', () => {
    console.log('‚úÖ Socket connected:', socket.id);
  });

  // L·∫Øng nghe d·ªØ li·ªáu sensor m·ªõi
  socket.on('data_from_esp32_update', data => {
    if (String(data.roomId) === roomId) {
      const now = new Date().toLocaleTimeString();
      const is_online = document.getElementById('is_online');
      const status_led = document.getElementById('status_led');
      const status_fan = document.getElementById('status_fan');
      const control_ledSection = document.getElementById('control_ledSection');
      const control_fanSection = document.getElementById('control_fanSection');

      if (typeof data.is_online === 'boolean') {
        is_online.className = 'status ' + (data.is_online ? 'on' : 'off');
        is_online.textContent = data.is_online ? 'üü¢ Tr·ª±c tuy·∫øn' : '‚ö´ Ngo·∫°i tuy·∫øn';
        
        status_led.className = 'status ' + (data.status_led === "ON" ? 'on' : 'off');
        status_led.textContent = data.status_led === "ON" ? 'üí° ƒêang b·∫≠t' : '‚ö´ ƒêang t·∫Øt';
        
        status_fan.className = 'status ' + (data.status_fan === "ON" ? 'on' : 'off');
        status_fan.textContent = data.status_fan === "ON" ? 'üåÄ ƒêang b·∫≠t' : '‚ö´ ƒêang t·∫Øt';
      
        let decryptedHumidity = data.humidity;
        if (data.enable_encryption == true) {
          console.log('tr∆∞·ªõc khi gi·∫£i m√£: ' + decryptedHumidity);
          decryptedHumidity = decryptAES(decryptedHumidity);
          console.log('sau khi gi·∫£i m√£: ' + decryptedHumidity);
        }

        tempChart.data.labels.push(now);
        tempChart.data.datasets[0].data.push(parseFloat(data.temperature));
        humidityChart.data.labels.push(now);
        humidityChart.data.datasets[0].data.push(parseFloat(decryptedHumidity));
      
        if (tempChart.data.labels.length > 30) {
          tempChart.data.labels.shift();
          tempChart.data.datasets[0].data.shift();
        }
        if (humidityChart.data.labels.length > 30) {
          humidityChart.data.labels.shift();
          humidityChart.data.datasets[0].data.shift();
        }
      
        tempChart.update();
        humidityChart.update();
      
        console.log('üìä Chart updated with new temperature:', data.temperature + '¬∞C');
        console.log('üìä Chart updated with new humidity:', data.humidity + '%');

        if (data.is_online) {
          control_ledSection.innerHTML = `<form action="/rooms/toggle_led/${data.roomId}" method="POST" style="margin-top:12px;">
            <button type="submit" id="toggleBtn_led">${data.status_led === "ON" ? 'üî¥ T·∫Øt ƒë√®n' : 'üü¢ B·∫≠t ƒë√®n'}</button>
            </form>`;
        } else {
          control_ledSection.innerHTML = `<p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è ƒê√®n ƒëang ngo·∫°i tuy·∫øn. Kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn.</p>`;
        }

        if (data.is_online && allowFan_control) {
          control_fanSection.innerHTML = 
          `<form action="/rooms/toggle_fan/${data.roomId}" method="POST" style="margin-top:12px;">
            <button type="submit" id="toggleBtn_fan">${data.status_fan === "ON" ? 'üî¥ T·∫Øt qu·∫°t' : 'üü¢ B·∫≠t qu·∫°t'}</button>
          </form>`;
        } else if (!data.is_online) {
          control_fanSection.innerHTML = 
          `<p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è Qu·∫°t ƒëang ngo·∫°i tuy·∫øn. Kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn.</p>`;
        } else if (!allowFan_control) {
          control_fanSection.innerHTML = `<p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è B·∫°n kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn qu·∫°t. H√£y v√†o c√†i ƒë·∫∑t ƒë·ªÉ c·∫•p quy·ªÅn.</p>`;
        }
      }
    }
  });
</script>
</body>
</html>
