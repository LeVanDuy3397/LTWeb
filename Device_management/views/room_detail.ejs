<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi ti·∫øt ph√≤ng - <%= room.name %></title>
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Qu·∫£n l√Ω thi·∫øt b·ªã</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="/dashboard">üìä B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
        <a href="/rooms">üè† Qu·∫£n l√Ω ph√≤ng</a>
        <a href="/history">üìú L·ªãch s·ª≠</a>
      </nav>
      <div class="sidebar-footer">
        <a href="/logout">üö™ ƒêƒÉng xu·∫•t</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <h2>Chi ti·∫øt ph√≤ng: <%= room.name %></h2>
      
      <div class="room-info">
  <p><strong>ƒê·ªãa ch·ªâ IP:</strong> <%= room.ip %></p>
  <p><strong>K·∫øt n·ªëi:</strong> <span id="onlineStatus" class="status <%= room.isOnline ? 'on' : 'off' %>"><%= room.isOnline ? 'üü¢ Tr·ª±c tuy·∫øn' : '‚ö´ Ngo·∫°i tuy·∫øn' %></span></p>
  <p><strong>Tr·∫°ng th√°i thi·∫øt b·ªã:</strong> <span id="deviceStatus" class="status <%= room.status ? 'on' : 'off' %>"><%= room.status ? 'üí° ƒêang b·∫≠t' : '‚ö´ ƒêang t·∫Øt' %></span></p>
        <div id="controlSection">
        <% if (room.isOnline) { %>
          <form action="/rooms/toggle/<%= room.id %>" method="POST" style="margin-top:12px;">
            <button type="submit" id="toggleBtn"><%= room.status ? 'üî¥ T·∫Øt thi·∫øt b·ªã' : 'üü¢ B·∫≠t thi·∫øt b·ªã' %></button>
          </form>
        <% } else { %>
          <p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è Thi·∫øt b·ªã ƒëang ngo·∫°i tuy·∫øn. Kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn.</p>
        <% } %>
        </div>
      </div>

      <div class="chart-container">
  <h3>üìà Bi·ªÉu ƒë·ªì nhi·ªát ƒë·ªô</h3>
        <canvas id="tempChart" width="400" height="150"></canvas>
      </div>

      <div class="chart-container" style="margin-top: 30px;">
  <h3>üìà Bi·ªÉu ƒë·ªì ƒë·ªô ·∫©m</h3>
        <canvas id="humidityChart" width="400" height="150"></canvas>
      </div>

      <div style="margin-top:20px;">
        <button onclick="location.href='/history/<%= room.id %>'">üìú Xem l·ªãch s·ª≠ ƒë·∫ßy ƒë·ªß</button>
      </div>
    </main>
  </div>
  <script>
    const tempData = JSON.parse('<%- JSON.stringify(history.map(h => h.temperature).reverse()) %>');
    const humidityData = JSON.parse('<%- JSON.stringify(history.map(h => h.humidity).reverse()) %>');
    const labels = JSON.parse('<%- JSON.stringify(history.map(h => (new Date(h.createdAt)).toLocaleTimeString()).reverse()) %>');
    const ctx = document.getElementById('tempChart').getContext('2d');
    
    const tempChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Nhi·ªát ƒë·ªô (¬∞C)',
          data: tempData,
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4, // ƒê∆∞·ªùng cong m∆∞·ª£t h∆°n
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: 'rgb(75, 192, 192)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgb(75, 192, 192)',
          pointHoverBorderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: {
          duration: 750, // Animation m∆∞·ª£t m√†
          easing: 'easeInOutQuart'
        },
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: {
                size: 13,
                weight: 'bold'
              }
            }
          },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            padding: 12,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              label: function(context) {
                return ' Nhi·ªát ƒë·ªô: ' + context.parsed.y.toFixed(1) + '¬∞C';
              }
            }
          }
        },
        scales: {
          x: {
            display: true,
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              maxTicksLimit: 10,
              font: {
                size: 11
              }
            }
          },
          y: {
            beginAtZero: true,
            min: 0,
            max: 60,
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              font: {
                size: 11
              },
              callback: function(value) {
                return value + '¬∞C';
              }
            }
          }
        }
      }
    });
    const humidityChart = new Chart(document.getElementById('humidityChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'ƒê·ªô ·∫©m (%)',
          data: humidityData,
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointRadius: 4,
          pointHoverRadius: 6,
          pointBackgroundColor: 'rgb(54, 162, 235)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgb(54, 162, 235)',
          pointHoverBorderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        animation: {
          duration: 750,
          easing: 'easeInOutQuart'
        },
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15,
              font: {
                size: 13,
                weight: 'bold'
              }
            }
          },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            padding: 12,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              label: function(context) {
                return ' ƒê·ªô ·∫©m: ' + context.parsed.y.toFixed(1) + '%';
              }
            }
          }
        },
        scales: {
          x: {
            display: true,
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              maxTicksLimit: 10,
              font: {
                size: 11
              }
            }
          },
          y: {
            beginAtZero: true,
            min: 0,
            max: 100
          }
        }
      }
    });
    
    // Socket.IO - Real-time updates
    const socket = io();
    const roomId = '<%= room.id %>';
    
    // L·∫Øng nghe d·ªØ li·ªáu sensor m·ªõi
    socket.on('sensorUpdate', data => {
      if (String(data.roomId) === roomId) {
        // C·∫≠p nh·∫≠t chart real-time v·ªõi animation m∆∞·ª£t
        const now = new Date().toLocaleTimeString();
        
        // Th√™m d·ªØ li·ªáu m·ªõi v√†o chart
        tempChart.data.labels.push(now);
        tempChart.data.datasets[0].data.push(parseFloat(data.temperature));
        
        // Gi·ªõi h·∫°n 30 ƒëi·ªÉm d·ªØ li·ªáu tr√™n chart
        if (tempChart.data.labels.length > 30) {
          tempChart.data.labels.shift();
          tempChart.data.datasets[0].data.shift();
        }
        
        tempChart.update();
        
        console.log('üìä Chart updated with new temperature:', data.temperature + '¬∞C');
      }
    });
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i thi·∫øt b·ªã real-time
    socket.on('roomDetailUpdate', data => {
      if (String(data.roomId) === roomId) {
        const onlineStatus = document.getElementById('onlineStatus');
        const deviceStatus = document.getElementById('deviceStatus');
        const controlSection = document.getElementById('controlSection');
        const toggleBtn = document.getElementById('toggleBtn');
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i online/offline
        if (typeof data.isOnline === 'boolean') {
          onlineStatus.className = 'status ' + (data.isOnline ? 'on' : 'off');
          onlineStatus.textContent = data.isOnline ? 'üü¢ Tr·ª±c tuy·∫øn' : '‚ö´ Ngo·∫°i tuy·∫øn';
          
          // C·∫≠p nh·∫≠t ph·∫ßn ƒëi·ªÅu khi·ªÉn
          if (data.isOnline) {
            controlSection.innerHTML = `
              <form action="/rooms/toggle/${roomId}" method="POST" style="margin-top:12px;">
                <button type="submit" id="toggleBtn">${data.status ? 'üî¥ T·∫Øt thi·∫øt b·ªã' : 'üü¢ B·∫≠t thi·∫øt b·ªã'}</button>
              </form>
            `;
          } else {
            controlSection.innerHTML = '<p style="color:#dc3545; margin-top:12px;">‚ö†Ô∏è Thi·∫øt b·ªã ƒëang ngo·∫°i tuy·∫øn. Kh√¥ng th·ªÉ ƒëi·ªÅu khi·ªÉn.</p>';
          }
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i thi·∫øt b·ªã (b·∫≠t/t·∫Øt)
        if (typeof data.status === 'boolean') {
          deviceStatus.className = 'status ' + (data.status ? 'on' : 'off');
          deviceStatus.textContent = data.status ? 'üí° ƒêang b·∫≠t' : '‚ö´ ƒêang t·∫Øt';
          
          // C·∫≠p nh·∫≠t n√∫t toggle n·∫øu online
          if (toggleBtn) {
            toggleBtn.textContent = data.status ? 'üî¥ T·∫Øt thi·∫øt b·ªã' : 'üü¢ B·∫≠t thi·∫øt b·ªã';
          }
        }
        
        console.log('üîÑ Room status updated:', data);
      }
    });
  </script>
</body>
</html>
